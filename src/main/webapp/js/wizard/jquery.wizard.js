(function(a,A){var s,p=0,x={},n={},f=Array.prototype.slice,g=function(C){return a.isArray(C)?C:[C]},u="id",t="form",o="click",z="submit",r="disabled",B="wizard",q="default",v="number",w="object",y="string",m="boolean",b="afterBackward",c="afterDestroy",d="afterForward",e="afterSelect",h="beforeBackward",i="beforeDestroy",j="beforeForward",k="beforeSelect",l="beforeSubmit";a.each("branch form header step wrapper".split(" "),function(){x[this]="."+(n[this]=B+"-"+this)});a.widget("kf."+B,{version:"1.0.0",options:{animations:{show:{options:{duration:0},properties:{opacity:"show"}},hide:{options:{duration:0},properties:{opacity:"hide"}}},backward:".backward",branches:".branch",disabled:false,enableSubmit:false,forward:".forward",header:":header:first",initialStep:0,stateAttribute:"data-state",stepClasses:{current:"current",exclude:"exclude",stop:"stop",submit:"submit",unidirectional:"unidirectional"},steps:".step",submit:":submit",transitions:{},unidirectional:false,afterBackward:null,afterDestroy:null,afterForward:null,afterSelect:null,beforeBackward:null,beforeDestroy:null,beforeForward:null,beforeSelect:null,create:null},_create:function(){var D,E,I=this,H=I.options,C=I.element,F=C.find(H.steps),G=F.eq(0).parent();if(C[0].elements){D=C}else{if(!(D=C.find(t)).length){D=C.closest(t)}}if(!(E=C.find(H.header)).length){E=D.find(H.header)}I.elements={form:D.addClass(n.form),submit:D.find(H.submit),forward:D.find(H.forward),backward:D.find(H.backward),header:E.addClass(n.header),steps:C.find(H.steps).hide().addClass(n.step),branches:C.find(H.branches).add(G).addClass(n.branch),stepsWrapper:G.addClass(n.wrapper),wizard:C.addClass(B)};if(!G.attr(u)){G.attr(u,B+"-"+(++p))}I.elements.forward.click(function(J){J.preventDefault();I.forward(J)});I.elements.backward.click(function(J){J.preventDefault();I.backward(J)});I._currentState={branchesActivated:[],stepsActivated:[]};I._stepCount=I.elements.steps.length;I._lastStepIndex=I._stepCount-1;I._branchLabels=[];I.elements.steps.each(function(J){I._branchLabels[J]=a(this).parent().attr(u)});I._excludesFilter=function(){return !a(this).hasClass(H.stepClasses.exclude)};if(!H.transitions[q]){H.transitions[q]=function(J){return I.stepIndex(J.nextAll(x.step))}}I.select.apply(I,g(H.initialStep))},_fastForward:function(J,F,C){var D=0,G=this,H=G._currentState.stepIndex,I=[H];if(a.isFunction(F)){C=F;F=A}(function E(){G._transition(H,function(L,K){if((H=G.stepIndex(L,K))===-1){throw new Error('[_fastForward]: Invalid step "'+L+'"')}else{if(a.inArray(H,I)>=0){throw new Error('[_fastForward]: Recursion detected on step "'+L+'"')}else{I.push(H);if(H===G._lastStepIndex||(F?++D:H)===J){C.call(G,H,I)}else{E()}}}})})()},_find:function(K,F,M){var D,G,H,J,L,E=[],C=F instanceof jQuery?F:a(F);function I(O,N){if(N===J){D=N;return false}}if(K!==null&&C.length){K=g(K);for(G=0,H=K.length;G<H;G++){D=null;J=K[G];L=typeof J;if(L===v){D=C.get(J)}else{if(L===y){D=document.getElementById(J.replace("#",""))}else{if(L===w){if(J instanceof jQuery&&J.length){J=J[0]}if(J.nodeType){C.each(I)}}}}if(D){E.push(D)}}}return M===false?E:a(E)},_move:function(J,C,H,F,D){var I=this,E=I._currentState;if(typeof C===m){D=F;F=H;H=C;C=A}function G(K,L){D.call(I,K,a.isArray(F)?F:F!==false?L:A)}if(H===true){if(J>0){I._fastForward(J,H,G)}else{D.call(I,E.stepsActivated[Math.max(0,J+(E.stepsActivated.length-1))])}}else{if((J=I.stepIndex(J,C))!==-1){if(J>E.stepIndex){I._fastForward(J,G)}else{G.call(I,J)}}}},_state:function(J,K){if(!this.isValidStepIndex(J)){return null}var H=this.options,I=a.extend(true,{},this._currentState);K=g(K||J);I.step=this.elements.steps.eq(J);I.branch=I.step.parent();I.branchStepCount=I.branch.children(x.step).length;I.isMovingForward=J>I.stepIndex;I.stepIndexInBranch=I.branch.children(x.step).index(I.step);var C,E,F,D=0,G=K.length;for(;D<G;D++){J=K[D];C=this._branchLabels[J];if(!I.stepIndex||I.stepIndex<J){if(a.inArray(J,I.stepsActivated)<0){I.stepsActivated.push(J);if(a.inArray(C,I.branchesActivated)<0){I.branchesActivated.push(C)}}}else{if(I.stepIndex>J){E=a.inArray(C,I.branchesActivated)+1;F=a.inArray(J,I.stepsActivated)+1;if(E>0){I.branchesActivated.splice(E,I.branchesActivated.length-1)}if(F>0){I.stepsActivated.splice(F,I.stepsActivated.length-1)}}}I.stepIndex=J;I.branchLabel=C}I.stepsComplete=Math.max(0,this._find(I.stepsActivated,this.elements.steps).filter(this._excludesFilter).length-1);I.stepsPossible=Math.max(0,this._find(I.branchesActivated,this.elements.branches).children(x.step).filter(this._excludesFilter).length-1);a.extend(I,{branchLabel:this._branchLabels[J],isFirstStep:J===0,isFirstStepInBranch:I.stepIndexInBranch===0,isLastStep:J===this._lastStepIndex,isLastStepInBranch:I.stepIndexInBranch===I.branchStepCount-1,percentComplete:(100*I.stepsComplete/I.stepsPossible),stepsRemaining:(I.stepsPossible-I.stepsComplete)});return I},_transition:function(J,E,D){var H=this;if(a.isFunction(J)){D=J;J=H._currentState.stepIndex;E=A}else{if(a.isFunction(E)){D=E;E=A}}var G,F=H.options,C=H.step(J,E),I=C.attr(F.stateAttribute),K=I?F.transitions[I]:F.transitions[q];if(a.isFunction(K)){G=K.call(H,C,function(){return D.apply(H,f.call(arguments))})}else{G=I}if(G!==A&&G!==false){D.apply(H,g(G))}return G},_update:function(D,F){var C=this._currentState,E=this.options;if(C.step){if(E.disabled||!F||F.stepIndex===C.stepIndex||!this._trigger(k,D,F)||(F.isMovingForward&&!this._trigger(j,D,F))||(!F.isMovingForward&&!this._trigger(h,D,F))){return}C.step.removeClass(E.stepClasses.current).animate(E.animations.hide.properties,a.extend({},E.animations.hide.options))}this._currentState=F;F.step.addClass(E.stepClasses.current).animate(E.animations.show.properties,a.extend({},E.animations.show.options));if(F.isFirstStep||E.unidirectional||F.step.hasClass(E.stepClasses.unidirectional)){this.elements.backward.attr(r,true)}else{this.elements.backward.removeAttr(r)}if((F.isLastStepInBranch&&!F.step.attr(E.stateAttribute))||F.step.hasClass(E.stepClasses.stop)){this.elements.forward.attr(r,true)}else{this.elements.forward.removeAttr(r)}if(E.enableSubmit||F.step.hasClass(E.stepClasses.submit)){this.elements.submit.removeAttr(r)}else{this.elements.submit.attr(r,true)}if(C.step){this._trigger(e,D,F);this._trigger(F.isMovingForward?d:b,D,F)}},backward:function(C,D){if(typeof C===v){D=C;C=A}if(D===A){D=1}if(this._currentState.isFirstStep||typeof D!==v){return}this._move(-D,true,false,function(E,F){this._update(C,this._state(E,F))})},branch:function(C){return arguments.length?this._find(C,this.elements.branches):this._currentState.branch},branches:function(C){return arguments.length?this.branch(C).children(x.branch):this.elements.branches},branchesActivated:function(){return this._find(this._currentState.branchesActivated,this.elements.branches)},destroy:function(){var C=this.elements;if(!this._trigger(i,null,this.state())){return}this.element.removeClass(B);C.form.removeClass(n.form);C.header.removeClass(n.header);C.steps.show().removeClass(n.step);C.stepsWrapper.removeClass(n.wrapper);C.branches.removeClass(n.branch);a.Widget.prototype.destroy.call(this);this._trigger(c)},form:function(){return this.elements.form},forward:function(C,E,D){if(typeof C===v){D=E;E=C;C=A}if(E===A){E=1}if(this._currentState.isLastStep||typeof E!==v){return}this._move(E,true,D,function(F,G){this._update(C,this._state(F,G))})},isValidStep:function(D,C){return this.isValidStepIndex(this.stepIndex(D,C))},isValidStepIndex:function(C){return typeof C===v&&C>=0&&C<=this._lastStepIndex},stepCount:function(){return this._stepCount},select:function(D,G,C,F,E){if(!(D instanceof a.Event)){E=F;F=C;C=G;G=D;D=A}if(G===A){return}if(a.isArray(G)){E=F;F=C;C=G[1];G=G[0]}else{if(typeof C===m){E=F;F=C;C=A}else{if(a.isArray(C)){E=C;C=A}}}this._move(G,C,F,E,function(H,I){this._update(D,this._state(H,I))})},state:function(D,C,E){if(!arguments.length){return this._currentState}if(a.isArray(D)){E=C;C=D[1];D=D[0]}else{if(a.isArray(C)){E=C;C=A}}return this._state(this.stepIndex(D,C),E)},step:function(E,D){if(!arguments.length){return this._currentState.step}if(a.isArray(E)){D=E[1];E=E[0]}var C,F=typeof E;if(F===v){C=this._find(E,D!==A?this.steps(D):this.elements.steps)}else{C=this._find(E,this.elements.steps.add(this.elements.branches));if(C&&C.hasClass(n.branch)){C=this._find(D||0,this.steps(C))}}return C},stepIndex:function(F,D,E){if(!arguments.length){return this._currentState.stepIndex}var C;if(a.isArray(F)){E=D;D=F[1];F=F[0]}else{if(typeof D===m){E=D;D=A}}return(C=this.step(F,D))?(E?C.siblings(x.step).andSelf():this.elements.steps).index(C):-1},steps:function(C){return arguments.length?this.branch(C).children(x.step):this.elements.steps},stepsActivated:function(){return this._find(this._currentState.stepsActivated,this.elements.steps)},submit:function(){this.elements.form.submit()}})})(jQuery);